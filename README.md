(split_pfd.py: pdf をページごとに分割)
(extract_tables.py: 1 つの Word ファイルから表を検出し tmp に表の csv を出力)
(extract_tables_fromE.py: excel フォルダ内にあるファイルを csv に変換)
extract_tables_fromW.py: word フォルダ内にあるファイルから表を抽出し、csv に変換
modify_csv.py: カラム名から不要なスペースを削除など
merge_tables.py: 各 csv のうち、フォーマットにあう表のみを結合。フォーマットに合わなかったものを出力

### 現在の作業手順(やったこと)

1. pdf を word に変換
2. `extract_tables_fromW.py`で各表を csv に出力
3. 出力 csv をパターンわけするために見たら、微修正で済むものが散見されたので手作業で修正。修正したものは manually_modified に移動(大体)。
4. `modify_csv.py`で多少フォーマットを整える(スペース削除)
5. `merge_tables.py`でフォーマットに合う表のみを結合。詳しい機能はプログラムの説明部分へ。

2 の修正パターンをいくつか示す。手作業でやってしまったが、modify_csv で対応できた部分も多い(結果論。そのパターンがどのくらいあるのかを把握するのに、同時に作業した方が早かった)

- 表名と作業名が 1 つになって表列に入り、作業列がない → 分割するだけ(どこで切るかの判定がプログラムを組もうとするとちょっと難あり)
- セル内改行により異なるフォーマットに見える → 見えるだけなので何も問題はないが、確認作業を簡単にするため改行を削除。
- 表名、作業名以外の項目は正しく取れていてこれらだけ欠けている →pdf を手動で参照して追加。csv ファイル名からページ番号とその表がページ内で何番目かわかる
- 一切取得できていない表の追加 → 別の修正をしていたら偶然取得できていない表を見つけたのでファイルのみ追加。すべて取得できているかのチェックを行う必要がある(最終マージ後にチェックすることはおそらく容易)
- カラム名が 2 行の扱いをされてしまっている(セル内改行とは別)→1 行に手動で結合。頑張ればプログラムも組めるけど、パターン漏れが出ないようにするのは難しそう。
- 他の修正をしながら、備考列が備列と考列にわかれているものを若干発見 → 見たものは直したが、これは modify_csv.py に追加すべき機能。

### extract_tables_fromW.py の説明

- DOCX ファイルからテーブルを抽出し、それぞれのテーブルを DataFrame として返す
- 「(注)」を含む行を見つけたら現在の表を終了。
- 「表」または「別表」を含む行が見つかったら、以下のルールで新しい表の開始する。
  1.  その「表」を含む行の次の次の行に「単位」という文字が含まれる場合：その「次の次の行」を新しい表の開始（ヘッダー）と判断し、「表」を含む行の次の行の文字列を「作業名」とする。
  2.  上記以外の場合（「次の次の行」に「単位」が含まれない場合）：「表」を含む行の次の行を新しい表の開始（ヘッダー）と判断し、「作業名」は空。
  3.  (注)表記を広い、まとめて最右列に追加す

「表」「作業名」が存在しない場合は、列の追加を行わない
出力先は、hyo または(以下詳しい説明は後日書きます)

### modify_csv.py の説明

- カラムと各セルに含まれる全角スペース、半角スペースの削除
- 備考列が備列と考列に分割されているものを、考列が空なら結合
- セル内改行の削除
- (今後追加したい機能)「(1m3 当たり)」のような表記を手作業で追加した部分があり、全角半角や「あたり-当たり」の表記揺れがあるかもしれないので修正

### merge_tables.py の説明

表列の要素が「表」から始まる場合と「別表」から始まる場合でマージ先を分けている。

1. 表列が存在しないものは Group3 に分類
2. カラム名が前から順に、['表', '作業名', '名称', '摘要', '単位', '所要量','備考']に一致するものはマージ対象(注列の有無は問わない)として Group1 に分類
3. 2 に該当しないもののうち、「所要量」列のみが別の要素である場合(「表,作業名,名称,摘要,単位,100t 吊,120t 吊,160t 吊,200t 吊,備考,注」、など)に単位と備考の間のカラム名を 1 つずつ作業名に結合し、縦に展開(どのような操作かは、data/tables_from_docx/hyo/4-2.csv(の表番号に対応する表 RA-1-2)が\data\tables_from_docx\combined_group1_main.csv でどのように展開されているかを確認するとわかります)。すると 2 と同じパターンになるので、Group1 に分類
4. 3 で Group1 に分類されなかったもの(所要量列以外に問題がある)のうち、表列が「表」「別表」以外で始まるものを Group4 に分類(少なくとも表は確実におかしい)
5. 4 で Group4 に分類されなかったもののうち、['名称', '摘要', '単位', '所要量','備考']のどれか 1 つが欠けているものを Group2 に分類(備考列を持たないものなどはある。前の判定で表列が存在することは約束されるが、作業名との分割ができていない可能性もある)
6. いずれにもあてはまらないものを Group3 に分類

現状、Group1(マージ済み)は表が 197、別表が 10 個あり、Group2 は 0、Group3 は 211、Group4 は 0 ファイルある。表として拾った 417 個のうち 207 個(49.6%)がマージできている。

マージできていない 211 ファイルのうち、直接見て歩掛に関係のない表と判断したものが 14 ファイルある。(data/tables_from_docx/other)

また、表取得の時点で失敗しており、1 つの表が複数ファイルに分割されてしまっているものが多い。マージできていない表の大半は 100 ページ以降のおよそ 120 個ほどであると予想される。これは表取得では大体 160 ファイルほどに分割されている。
残りの 40 ファイルほどは(211-14-160)、表の取得は正しいがカラム名が不一致なもの、カラム名の取得に失敗しているが大体の表の取得はできているものだとみられる。

### メモ

注がとれないのがなんでか不明、これはエクセル版から取ってきたらうまくいくのかもしれない

想定する流れは、表番号が完全なマージを作成 → それとエクセル版を参照しながら注を入れる、くらい

100 ページ目以降の表データについては、エクセルではおおよそ取得できているので使えそう
